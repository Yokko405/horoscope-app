// fetch-horoscope.js
// === Cosmic Fortune Horoscope Fetcher ===
// API-Ninjas ã‹ã‚‰12æ˜Ÿåº§ã®é‹å‹¢ã‚’å–å¾—ã—ã¦ JSON å‡ºåŠ›ï¼ˆBOMãªã—ï¼‰

const https = require('https');
const fs = require('fs');
const path = require('path');

// å¯¾è±¡ã®12æ˜Ÿåº§
const zodiacSigns = [
  'aries', 'taurus', 'gemini', 'cancer',
  'leo', 'virgo', 'libra', 'scorpio',
  'sagittarius', 'capricorn', 'aquarius', 'pisces'
];

// Secrets ã‹ã‚‰ APIã‚­ãƒ¼ã‚’å–å¾—
const API_KEY = process.env.API_NINJAS_KEY;

// ===== Horoscopeå–å¾—é–¢æ•° =====
function fetchHoroscope(sign) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.api-ninjas.com',
      path: `/v1/horoscope?zodiac=${sign}`,
      method: 'GET',
      headers: {
        'X-Api-Key': API_KEY
      }
    };

    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        if (res.statusCode !== 200) {
          return reject(new Error(`HTTP ${res.statusCode} for ${sign}: ${data}`));
        }
        try {
          const json = JSON.parse(data);
          resolve(json);
        } catch (error) {
          reject(new Error(`Failed to parse JSON for ${sign}: ${error.message}`));
        }
      });
    });

    req.on('error', (error) => reject(error));
    req.end();
  });
}

// ===== å…¨æ˜Ÿåº§åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å‡ºåŠ› =====
async function fetchAllHoroscopes() {
  console.log('=== ðŸŒŸ Fetching horoscope data for all zodiac signs ===');
  const horoscopes = {};
  const errors = [];

  for (const sign of zodiacSigns) {
    try {
      console.log(`ðŸ”® Fetching ${sign}...`);
      const data = await fetchHoroscope(sign);
      horoscopes[sign] = data;
      console.log(`âœ… ${sign} - Success`);
      await new Promise(resolve => setTimeout(resolve, 800)); // rate limitå¯¾ç­–
    } catch (error) {
      console.error(`âŒ ${sign} - Failed: ${error.message}`);
      errors.push({ sign, error: error.message });
    }
  }

  // JSTã®æ—¥ä»˜ã‚’ç”Ÿæˆ
  const now = new Date();
  const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
  const jstDate = jst.toISOString().split('T')[0];

  const outputData = {
    updated_at: now.toISOString(),
    jst_date: jstDate,
    timezone: 'Asia/Tokyo',
    horoscopes,
    errors: errors.length > 0 ? errors : undefined
  };

  const dataDir = path.join(__dirname, 'data');
  if (!fs.existsSync(dataDir)) fs.mkdirSync(dataDir, { recursive: true });
  const outputPath = path.join(dataDir, 'horoscope.json');

  // âœ… BOMã‚’ä»˜ã‘ãšã«UTF-8ã§å‡ºåŠ›
  fs.writeFileSync(outputPath, Buffer.from(JSON.stringify(outputData, null, 2), 'utf8'));

  console.log('\n=== Summary ===');
  console.log(`âœ… Successfully fetched: ${Object.keys(horoscopes).length}/${zodiacSigns.length}`);
  if (errors.length > 0) console.log(`âš ï¸  Failed: ${errors.length} signs`);
  console.log(`ðŸ—‚ï¸  Data saved to: ${outputPath}`);
}

// ===== å®Ÿè¡Œ =====
fetchAllHoroscopes()
  .then(() => {
    console.log('\nðŸŒ™ Horoscope data update completed successfully!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nðŸ’€ Fatal error:', error);
    process.exit(1);
  });
